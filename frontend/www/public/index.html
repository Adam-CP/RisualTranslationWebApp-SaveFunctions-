<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name=viewport content="width=device-width, initial-scale=1">
    <meta name="description" content="The Monkey Bar">
    <title>Speech Translator Web App</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div class="wrapper">
      <div class="sidebar">
        <input class="sidebar-item" type="file" id="file-picker" accept=".wav" name="file-picker">       
        <div class="sidebar-item">
          <div class="label-text">Source language</div>
          <!-- For the full list of supported languages see:
          https://docs.microsoft.com/azure/cognitive-services/speech-service/supported-languages -->
          <select id="language-options">
            <option value="ar-EG">Arabic - EG</option>
            <option value="ca-ES">Catalan - ES</option>
            <option value="zh-CN">Chinese - CN</option>
            <option value="zh-HK">Chinese - HK</option>
            <option value="zh-TW">Chinese - TW</option>
            <option value="da-DK">Danish - DK</option>
            <option value="da-DK">Danish - DK</option>
            <option value="nl-NL">Dutch - NL</option>
            <option value="en-AU">English - AU</option>
            <option value="en-CA">English - CA</option>
            <option value="en-GB">English - GB</option>
            <option value="en-IN">English - IN</option>
            <option value="en-NZ">English - NZ</option>
            <option value="en-US" selected="selected">English - US</option>
            <option value="de-DE">German - DE</option>
            <option value="es-ES">Spanish - ES</option>
            <option value="es-MX">Spanish - MX</option>
            <option value="fi-FI">Finnish - FI</option>
            <option value="fr-CA">French - CA</option>
            <option value="fr-FR">French - FR</option>
            <option value="hi-IN">Hindi - IN</option>
            <option value="it-IT">Italian - IT</option>
            <option value="ja-JP">Japanese - JP</option>
            <option value="ko-KR">Korean - KR</option>
            <option value="nb-NO">Norwegian - NO</option>
            <option value="pl-PL">Polish - PL</option>
            <option value="pt-BR">Portuguese - BR</option>
            <option value="pt-PT">Portuguese - PT</option>
            <option value="ru-RU">Russian - RU</option>
            <option value="sv-SE">Swedish - SE</option>
        </select>           
        </div>

        <button type="button" class="sidebar-item" id="save-changes-button">Save Changes</button>
        <button type="button" class="sidebar-item" id="save-transcript-button">Save Transcript</button>
        <button type="button" class="sidebar-item" id="start-translation-button">Start Translation</button>
        <button type="button" class="sidebar-item" id="stop-translation-button">Stop Translation</button>

        <div class="sidebar-item">
          <div class="label-text">Subscription key</div>
          <input type="text" id="subscription-key-text" name="subscription-key-text">
        </div>

        <div class="sidebar-item">
          <div class="label-text">Region</div>
          <select id="region-options">
            <option value="westus">West US</option>
            <option value="westus2">West US 2</option>
            <option value="eastus">East US</option>
            <option value="eastus2">East US 2</option>
            <option value="eastasia">East Asia</option>
            <option value="southeastasia">South East Asia</option>
            <option value="northeurope">North Europe</option>
            <option value="westeurope" selected="selected">West Europe</option>
            <option value="usgovarizona">US Gov Arizona</option>
            <option value="usgovvirginia">US Gov Virginia</option>
          </select>
        </div>

        <audio class="sidebar-item" id="audio-player" controls preload></audio>
                
      </div>      
      <div class="main">
        <div class="text-boxes">
          <textarea id="real-time-transcript-textarea" name="real-time-transcript-textarea" rows="4" cols="50"></textarea>
        </div>
        <button onclick="topFunction()" id="top-btn" title="Go to top">Top</button>
      </div>
    </div>

    <!-- Speech SDK REFERENCE -->
    <script src="https://aka.ms/csspeech/jsbrowserpackageraw"></script>

    <!-- Library for generating Lorem Ipsum text
    https://github.com/fffilo/lorem-ipsum-js -->
    <script src="lorem-ipsum.js"></script>

    <!-- Speech SDK presence check -->
    <script>
      // On document load resolve the Speech SDK dependency
      function Initialize(onComplete) {
          if (!!window.SpeechSDK) {
              onComplete(window.SpeechSDK);
          }
      }
    </script>

    <script>      
      const queryString = window.location.search;
      const urlParams = new URLSearchParams(queryString);
      if (urlParams) {
        const lorem = urlParams.get('lorem')
        if (lorem == "true") {
          loremIpsumRun = true;
          console.log("Simulation lorem ipsum run enabled");
        }
      }

      document.addEventListener("DOMContentLoaded", function () {
        var SpeechSDK;

        Initialize(function (speechSdk) {
            SpeechSDK = speechSdk;           
        });
      });  
    </script>

    <script>
      /* 
          Appends an "editable-text-box" in the "text-boxes" div in the following format.

          <div class="editable-text-box">
              <textarea class="editable-textarea" name="editable-text" rows="4" cols="50"></textarea>
              <div class="play-snippet-wrapper">
                  <img class="play-snippet-button" src="images/play-snippet.jpg" alt="play snippet">
              </div>
          </div>
      */
      function appendEditableTextBox(text, textAreaID, playButtonID) {
          var textBox=document.createElement("div");
          textBox.className = "editable-text-box";

          var editableTextArea=document.createElement("textarea");
          editableTextArea.className = "editable-textarea";
          editableTextArea.id = textAreaID;
          editableTextArea.value = text;
          editableTextArea.rows = "4";
          editableTextArea.cols = "50";
          textBox.appendChild(editableTextArea);

          var playSnippetWrapper=document.createElement("div");
          playSnippetWrapper.className = "play-snippet-wrapper"; 
          textBox.appendChild(playSnippetWrapper);    

          var playSnippetImg=document.createElement("img");
          playSnippetImg.className = "play-snippet-button";
          playSnippetImg.alt = "play snippet";
          playSnippetImg.src = "images/play-snippet.jpg";
          playSnippetImg.id = playButtonID;
          playSnippetWrapper.appendChild(playSnippetImg);

          document.getElementsByClassName('text-boxes')[0].appendChild(textBox);
      }
    </script>

    <script>
        var loremIpsumRun = false;
        var speechTranslationConfig = undefined;
        var recognizer = undefined;
        var audioFile = undefined;
        var textBoxCount = 0;
        var lorumIpsumTimer;
        var textBoxDetails = {}; 
        var audioSnippetEndTime = 0;      
        var filePicker = document.getElementById("file-picker");
        var audioPlayer = document.getElementById("audio-player");
        var realTimeTextArea = document.getElementById("real-time-transcript-textarea");
        var stopTranslationButton = document.getElementById("stop-translation-button");
        var startTranslationButton = document.getElementById("start-translation-button");

        class EditableTextBoxDetails {
          constructor(textAreaID, audioOffsetInTicks, audioDurationInTicks) {
            this.textAreaID = textAreaID;
            this.audioOffsetInTicks = audioOffsetInTicks;
            this.audioDurationInTicks = audioDurationInTicks;

            /* A single tick represents one hundred nanoseconds or one ten-millionth of a second.
               There's 1e9 nanoseconds in a second, and there's 100 nanoseconds per tick, so dividing by
               1e7 gives the time in seconds. */
            this.audioOffsetInSecs = audioOffsetInTicks / 10000000;
            this.audioDurationInSecs = audioDurationInTicks / 10000000;
          }
        }

        audioPlayer.addEventListener("timeupdate", function() {
            if(this.currentTime >= audioSnippetEndTime) {
                this.pause();
            }
        });

        filePicker.addEventListener("change", function () {
            audioFile = filePicker.files[0];  
            audioPlayer.src = URL.createObjectURL(audioFile);   
            sound.onend = function(e) {
              URL.revokeObjectURL(this.src);
            }
        });

        function playInterval(start, stop) {
          audioPlayer.currentTime = start;
          audioSnippetEndTime = stop;
          audioPlayer.play();
        }

        function playSnippetClick(event) {
          details = textBoxDetails[event.target.id];
          console.log(event.target.id + 
            `' clicked: playing audio at offset ${details.audioOffsetInSecs}s for ${details.audioDurationInSecs}s`);          
          playInterval(details.audioOffsetInSecs, details.audioOffsetInSecs + details.audioDurationInSecs);
        }

        function intToPlayButtonID(n) {
          return "play-button-" + n.toString() + "-id";
        }

        function intToTextAreaID(n) {
          return "text-area-" + n.toString() + "-id";
        }

        function printAllPhraseDetails() {
          for (let i = 0; i < textBoxCount; i++) {
            let playButtonID = intToPlayButtonID(i);
            details = textBoxDetails[playButtonID];
            let text = document.getElementById(details.textAreaID).value;
            console.log(`${i}\n${details.audioOffsetInSecs}s -> ${details.audioOffsetInSecs + details.audioDurationInSecs}s\n${text}\n\n`); 
          }
        }

        function addLoremIpsum() {
          if (textBoxCount > 10)
            clearInterval(lorumIpsumTimer);

          let textAreaID = intToTextAreaID(textBoxCount);
          let playButtonID = intToPlayButtonID(textBoxCount);
          let ipsum = new LoremIpsum();
          let sentence = ipsum.sentence(8, 12);

          textBoxDetails[playButtonID] = new EditableTextBoxDetails(textAreaID, textBoxCount * 10000000, 10000000);
          appendEditableTextBox(sentence, textAreaID, playButtonID);

          document.getElementById(playButtonID).addEventListener("click", playSnippetClick);
          realTimeTextArea.value += sentence + "\n";
          textBoxCount++;
        }

        function addTranslation(result) {
          let textAreaID = intToTextAreaID(textBoxCount);
          let playButtonID = intToPlayButtonID(textBoxCount);

          let translation = result.translations.get("en");
          textBoxDetails[playButtonID] = new EditableTextBoxDetails(textAreaID, result.offset, result.duration);
          appendEditableTextBox(translation, textAreaID, playButtonID);

          document.getElementById(playButtonID).addEventListener("click", playSnippetClick);
          realTimeTextArea.value += translation + "\n";
          textBoxCount++;
        }
        
        stopTranslationButton.addEventListener("click", function () {
          if (recognizer)
            recognizer.stopContinuousRecognitionAsync();

          if (loremIpsumRun)
            clearInterval(lorumIpsumTimer);
        });

        startTranslationButton.addEventListener("click", function () {
          if (loremIpsumRun) {
            lorumIpsumTimer = setInterval(addLoremIpsum, 2000);
            addLoremIpsum();
            return;
          }

          if (!audioFile) {
            alert("Please select an audio file");
            return;
          }

          let subscriptionKeyText = document.getElementById("subscription-key-text");

          if (subscriptionKeyText.value.length == 0) {
            alert("Please enter a subscription key");
            return;            
          }

          let regionOptions = document.getElementById("region-options");
          speechTranslationConfig = SpeechSDK.SpeechTranslationConfig.fromSubscription(
            subscriptionKeyText.value, regionOptions.value);

          speechTranslationConfig.outputFormat = SpeechSDK.OutputFormat.Detailed;  

          const audioConfig = SpeechSDK.AudioConfig.fromWavFileInput(audioFile); 
          
          speechTranslationConfig.addTargetLanguage("en-US");
          speechTranslationConfig.speechRecognitionLanguage = document.getElementById("language-options").value;
                     
          recognizer = new SpeechSDK.TranslationRecognizer(speechTranslationConfig, audioConfig);

          recognizer.recognizing = (s, e) => {
              console.log(`TRANSLATING: Text=${e.result.text}`);
          };
          recognizer.recognized = (s, e) => {
              if (e.result.reason == SpeechSDK.ResultReason.TranslatedSpeech) {
                console.log(`TRANSLATED: Text=${e.result.text}`);

                if (e.result.translations) {
                  addTranslation(e.result);
                }
              }
              else if (e.result.reason == SpeechSDK.ResultReason.NoMatch) {
                  console.log("NOMATCH: Speech could not be translated.");
              }
          };
          recognizer.canceled = (s, e) => {
              console.log(`CANCELED: Reason=${e.reason}`);
              if (e.reason == CancellationReason.Error) {
                  console.log(`"CANCELED: ErrorCode=${e.errorCode}`);
                  console.log(`"CANCELED: ErrorDetails=${e.errorDetails}`);
                  console.log("CANCELED: Did you update the subscription info?");
              }
              recognizer.stopContinuousRecognitionAsync();
          };
          recognizer.sessionStopped = (s, e) => {
              console.log("\n    Session stopped event.");
              recognizer.stopContinuousRecognitionAsync();
          };

          recognizer.startContinuousRecognitionAsync();  
        });
    </script>

    <script>
      topbutton = document.getElementById("top-btn");

      window.onscroll = function () { scrollFunction() };

      function scrollFunction() {
        if (document.body.scrollTop > 600 || document.documentElement.scrollTop > 600 && screen.width < 700) {
          topbutton.style.display = "block";
        } else {
          topbutton.style.display = "none";
        }
      }

      function topFunction() {
        document.body.scrollTop = 0;
        document.documentElement.scrollTop = 0;
      }
    </script>
</body>
</html>
